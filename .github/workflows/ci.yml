name: Glue CI/CD

on:
  push:
    branches:
      - main
      - develop

  pull_request:
    branches:
      - main
      - develop

  workflow_dispatch:

jobs:
  glue:
    runs-on: ubuntu-latest

    env:
      BUCKET: airport-airline-operations-analytics-platform
      SCRIPT: glue_job.py
      KEY: scripts/glue_job.py
      STACK: glue-cicd-stack
      JOB: FinalGlue

    steps:

      # -------------------
      # Checkout
      # -------------------
      - uses: actions/checkout@v4

      - name: Show files
        run: ls -R


      # -------------------
      # AWS Login
      # -------------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}


      # -------------------
      # Upload Glue script FIRST
      # -------------------
      - name: Upload Glue Script
        run: |
          test -f $SCRIPT || (echo "❌ glue_job.py missing" && exit 1)
          aws s3 cp $SCRIPT s3://$BUCKET/$KEY

      - name: Verify S3 Script
        run: aws s3 ls s3://$BUCKET/$KEY


      # -------------------
      # Deploy / Update Stack
      # -------------------
      - name: Deploy CloudFormation
        run: |
          test -f template.yaml || (echo "❌ template.yaml missing" && exit 1)

          aws cloudformation deploy \
            --stack-name $STACK \
            --template-file template.yaml \
            --parameter-overrides \
              ScriptBucket=$BUCKET \
              ScriptKey=$KEY \
              JobName=$JOB \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset


      # -------------------
      # Wait until Glue job exists
      # -------------------
      - name: Wait for Glue Job
        run: |
          for i in {1..20}; do
            if aws glue get-job --job-name $JOB >/dev/null 2>&1; then
              echo "✅ Job exists"
              exit 0
            fi
            echo "Waiting for job..."
            sleep 15
          done
          echo "❌ Job not created"
          exit 1


      # -------------------
      # Force metadata refresh (fix missing metadata error)
      # -------------------
      - name: Refresh Job Metadata
        run: |
          aws glue update-job \
            --job-name $JOB \
            --job-update "Command={Name=glueetl,ScriptLocation=s3://$BUCKET/$KEY,PythonVersion=3}"


      # -------------------
      # Start Glue Job
      # -------------------
      - name: Start Job
        run: |
          ID=$(aws glue start-job-run \
            --job-name $JOB \
            --query JobRunId \
            --output text)

          echo "RUN_ID=$ID" >> $GITHUB_ENV
          echo "Started: $ID"


      # -------------------
      # Wait for completion
      # -------------------
      - name: Wait for Completion
        run: |
          for i in {1..40}; do
            S=$(aws glue get-job-run \
              --job-name $JOB \
              --run-id $RUN_ID \
              --query JobRun.JobRunState \
              --output text)

            echo "Status: $S"

            if [ "$S" = "SUCCEEDED" ]; then exit 0; fi
            if [ "$S" = "FAILED" ] || [ "$S" = "STOPPED" ]; then exit 1; fi

            sleep 30
          done

          echo "Timeout"
          exit 1
