name: Glue Full CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1

      BUCKET: airport-airline-operations-analytics-platform

      GLUE_SCRIPT: glue_job.py
      GLUE_SCRIPT_KEY: scripts/glue_job.py

      RAW_LAMBDA_FILE: raw_lambda.py
      RAW_LAMBDA_KEY: lambda/raw_lambda.zip

      CRAWLER_LAMBDA_FILE: crawler_lambda.py
      CRAWLER_LAMBDA_KEY: lambda/crawler_lambda.zip

      GLUE_STACK: glue-stack
      CRAWLER_STACK: crawler-stack
      RAW_LAMBDA_STACK: raw-lambda-stack
      CRAWLER_LAMBDA_STACK: crawler-lambda-stack

      GLUE_JOB: FinalGlue

    steps:
      # --------------------
      # Checkout
      # --------------------
      - uses: actions/checkout@v4

      # --------------------
      # AWS Credentials
      # --------------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # --------------------
      # Sanity checks (fail fast)
      # --------------------
      - name: Verify S3 paths exist
        run: |
          aws s3 ls s3://$BUCKET/scripts/
          aws s3 ls s3://$BUCKET/scripts/glue_job.py

      # --------------------
      # Upload Glue script
      # --------------------
      - name: Upload Glue Script
        run: |
          aws s3 cp "$GLUE_SCRIPT" "s3://$BUCKET/$GLUE_SCRIPT_KEY"

      # --------------------
      # Deploy Glue Job Stack (10 workers already in CFT)
      # --------------------
      - name: Deploy Glue Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$GLUE_STACK" \
            --template-file glue-template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1

      # --------------------
      # Deploy Crawler Stack
      # --------------------
      - name: Deploy Crawler Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$CRAWLER_STACK" \
            --template-file crawler-template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1

      # --------------------
      # Wait for Glue Job completion
      # --------------------
      - name: Wait for Glue Job
        run: |
          echo "Waiting for Glue Job: $GLUE_JOB"
          for i in {1..80}; do
            STATUS=$(aws glue get-job-runs \
              --job-name "$GLUE_JOB" \
              --query 'JobRuns[0].JobRunState' \
              --output text \
              --region ap-south-1)

            echo "Glue Job Status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              echo "Glue Job completed successfully"
              exit 0
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ]; then
              echo "Glue Job failed"
              exit 1
            fi

            sleep 30
          done

          echo "Glue Job timed out"
          exit 1

      # --------------------
      # Wait for Airline Crawler
      # --------------------
      - name: Wait for Airline Crawler
        run: |
          echo "Waiting for Airline Crawler"
          while true; do
            STATE=$(aws glue get-crawler \
              --name airline \
              --query 'Crawler.State' \
              --output text \
              --region ap-south-1)

            echo "Airline Crawler: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      # --------------------
      # Wait for Customers Crawler
      # --------------------
      - name: Wait for Customers Crawler
        run: |
          echo "Waiting for Customers Crawler"
          while true; do
            STATE=$(aws glue get-crawler \
              --name customers \
              --query 'Crawler.State' \
              --output text \
              --region ap-south-1)

            echo "Customers Crawler: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      # --------------------
      # Done
      # --------------------
      - name: DONE
        run: echo "✅ CI/CD SUCCESS — Glue Job (10 Workers) + Crawlers Completed"
