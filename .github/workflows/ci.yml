name: Glue CI/CD Full (With Lambda)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1

      BUCKET: airport-airline-operations-analytics-platform

      GLUE_SCRIPT: glue_job.py
      GLUE_SCRIPT_KEY: scripts/glue_job.py

      RAW_LAMBDA_FILE: raw_lambda.py
      RAW_LAMBDA_KEY: lambda/raw_lambda.zip

      GLUE_STACK: glue-stack
      CRAWLER_STACK: crawler-stack
      LAMBDA_STACK: lambda-stack

      GLUE_JOB: FinalGlue

    steps:
      # --------------------
      # Checkout
      # --------------------
      - uses: actions/checkout@v4

      # --------------------
      # AWS Credentials
      # --------------------
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      # --------------------
      # Verify S3 Paths
      # --------------------
      - name: Verify S3 paths
        run: |
          aws s3 ls s3://$BUCKET/scripts/
          aws s3 ls s3://$BUCKET/scripts/glue_job.py

      # --------------------
      # Upload Glue Script
      # --------------------
      - name: Upload Glue Script
        run: |
          aws s3 cp "$GLUE_SCRIPT" "s3://$BUCKET/$GLUE_SCRIPT_KEY"

      # --------------------
      # Package Lambda
      # --------------------
      - name: Package Lambda
        run: |
          zip -j lambda.zip "$RAW_LAMBDA_FILE"
          aws s3 cp lambda.zip "s3://$BUCKET/$RAW_LAMBDA_KEY"

      # --------------------
      # Deploy Glue Job Stack
      # --------------------
      - name: Deploy Glue Job Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$GLUE_STACK" \
            --template-file glue-template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1

      # --------------------
      # Deploy Crawlers Stack
      # --------------------
      - name: Deploy Crawlers Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$CRAWLER_STACK" \
            --template-file crawler-template.yaml \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1

      # --------------------
      # Deploy Lambda Stack
      # --------------------
      - name: Deploy Lambda Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$LAMBDA_STACK" \
            --template-file lambda-template.yaml \
            --parameter-overrides \
              LambdaName=raw-trigger-lambda \
              CodeBucket=$BUCKET \
              CodeKey=$RAW_LAMBDA_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ap-south-1

      # --------------------
      # Invoke Lambda
      # --------------------
      - name: Invoke Lambda
        run: |
          aws lambda invoke \
            --function-name raw-trigger-lambda \
            response.json \
            --region ap-south-1
          cat response.json

      # --------------------
      # Wait for Glue Job
      # --------------------
      - name: Wait for Glue Job
        run: |
          echo "Waiting for Glue Job: $GLUE_JOB"
          for i in {1..80}; do
            STATUS=$(aws glue get-job-runs \
              --job-name "$GLUE_JOB" \
              --query 'JobRuns[0].JobRunState' \
              --output text \
              --region ap-south-1)

            echo "Glue Job Status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              exit 0
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ]; then
              exit 1
            fi

            sleep 30
          done

          exit 1

      # --------------------
      # Wait Airline Crawler
      # --------------------
      - name: Wait Airline Crawler
        run: |
          while true; do
            STATE=$(aws glue get-crawler \
              --name airline \
              --query 'Crawler.State' \
              --output text \
              --region ap-south-1)
            echo "Airline: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      # --------------------
      # Wait Customers Crawler
      # --------------------
      - name: Wait Customers Crawler
        run: |
          while true; do
            STATE=$(aws glue get-crawler \
              --name customers \
              --query 'Crawler.State' \
              --output text \
              --region ap-south-1)
            echo "Customers: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      # --------------------
      # DONE
      # --------------------
      - name: DONE
        run: echo "✅ SUCCESS — Lambda + Glue Job (10 Workers) + Crawlers Completed"
