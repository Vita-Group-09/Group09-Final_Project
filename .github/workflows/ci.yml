name: Full Glue CI/CD

on:
  push:
    branches: [ "develop" ]

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      S3_BUCKET: airport-airline-operations-analytics-platform

      GLUE_SCRIPT: glue_job.py
      GLUE_SCRIPT_KEY: scripts/glue_job.py

      RAW_LAMBDA_ZIP: raw_lambda.zip
      RAW_LAMBDA_KEY: lambda/raw_lambda.zip

      CRAWLER_LAMBDA_ZIP: crawler_lambda.zip
      CRAWLER_LAMBDA_KEY: lambda/crawler_lambda.zip

      GLUE_STACK: glue-stack
      CRAWLER_STACK: crawler-stack
      LAMBDA_STACK: lambda-stack

      GLUE_JOB: FinalGlue
      RAW_LAMBDA_NAME: raw-trigger-lambda
      CRAWLER_LAMBDA_NAME: crawler-trigger-lambda

    steps:

# =========================
# Checkout
# =========================
      - uses: actions/checkout@v4

# =========================
# Show files (debug)
# =========================
      - run: ls -R

# =========================
# Python
# =========================
      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"

# =========================
# AWS Login
# =========================
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

# =========================
# Upload Glue Script
# =========================
      - name: Upload Glue Script
        run: |
          test -f $GLUE_SCRIPT || exit 1
          aws s3 cp $GLUE_SCRIPT s3://$S3_BUCKET/$GLUE_SCRIPT_KEY

# =========================
# Package Lambda 1 (Raw â†’ Glue)
# =========================
      - name: Package Raw Lambda
        run: |
          test -f raw_lambda.py || exit 1
          zip raw_lambda.zip raw_lambda.py
          aws s3 cp raw_lambda.zip s3://$S3_BUCKET/$RAW_LAMBDA_KEY

# =========================
# Package Lambda 2 (Glue â†’ Crawlers)
# =========================
      - name: Package Crawler Lambda
        run: |
          test -f crawler_lambda.py || exit 1
          zip crawler_lambda.zip crawler_lambda.py
          aws s3 cp crawler_lambda.zip s3://$S3_BUCKET/$CRAWLER_LAMBDA_KEY

# =========================
# Deploy Glue CFT
# =========================
      - name: Deploy Glue Stack
        run: |
          aws cloudformation deploy \
            --stack-name $GLUE_STACK \
            --template-file glue-template.yml \
            --parameter-overrides \
              ScriptBucket=$S3_BUCKET \
              ScriptKey=$GLUE_SCRIPT_KEY \
              JobName=$GLUE_JOB \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

# =========================
# Deploy Crawler CFT
# =========================
      - name: Deploy Crawler Stack
        run: |
          aws cloudformation deploy \
            --stack-name $CRAWLER_STACK \
            --template-file crawler-template.yml \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

# =========================
# Deploy Lambda CFT
# =========================
      - name: Deploy Lambda Stack
        run: |
          aws cloudformation deploy \
            --stack-name $LAMBDA_STACK \
            --template-file lambda-template.yml \
            --parameter-overrides \
              CodeBucket=$S3_BUCKET \
              RawLambdaKey=$RAW_LAMBDA_KEY \
              CrawlerLambdaKey=$CRAWLER_LAMBDA_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

# =========================
# Invoke Lambda #1 â†’ starts Glue
# =========================
      - name: Invoke Raw Lambda
        run: |
          aws lambda invoke \
            --function-name $RAW_LAMBDA_NAME \
            --payload '{}' out.json
          cat out.json

# =========================
# Wait Glue Job SUCCESS
# =========================
      - name: Wait Glue Job
        run: |
          RID=$(aws glue get-job-runs \
            --job-name $GLUE_JOB \
            --max-items 1 \
            --query 'JobRuns[0].Id' \
            --output text)

          for i in {1..80}; do
            S=$(aws glue get-job-run \
              --job-name $GLUE_JOB \
              --run-id $RID \
              --query JobRun.JobRunState \
              --output text)

            echo "Glue status: $S"

            [[ "$S" == "SUCCEEDED" ]] && exit 0
            [[ "$S" == "FAILED" || "$S" == "STOPPED" ]] && exit 1

            sleep 30
          done

          exit 1

# =========================
# Invoke Lambda #2 â†’ start crawlers
# =========================
      - name: Invoke Crawler Lambda
        run: |
          aws lambda invoke \
            --function-name $CRAWLER_LAMBDA_NAME \
            --payload '{}' out2.json
          cat out2.json

# =========================
# Wait Airline Crawler
# =========================
      - name: Wait airline crawler
        run: |
          while true; do
            S=$(aws glue get-crawler --name airline --query 'Crawler.State' --output text)
            echo $S
            [[ "$S" == "READY" ]] && break
            sleep 20
          done

# =========================
# Wait Customers Crawler
# =========================
      - name: Wait customers crawler
        run: |
          while true; do
            S=$(aws glue get-crawler --name customers --query 'Crawler.State' --output text)
            echo $S
            [[ "$S" == "READY" ]] && break
            sleep 20
          done

# =========================
# Done
# =========================
      - name: Success
        run: echo "ðŸš€ FULL PIPELINE SUCCESS"
