name: Glue CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  glue-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Upload Glue script
        run: |
          aws s3 cp glue_job.py \
          s3://airport-airline-operations-analytics-platform/scripts/glue_job.py

      - name: Deploy Glue Job Stack
        run: |
          aws cloudformation deploy \
            --stack-name glue-cicd-stack \
            --template-file template.yaml \
            --parameter-overrides \
              ScriptBucket=airport-airline-operations-analytics-platform \
              ScriptKey=scripts/glue_job.py \
              JobName=FinalGlue \
            --capabilities CAPABILITY_NAMED_IAM

      # ---------------- GLUE JOB ----------------
      - name: Run Glue Job and Wait
        run: |
          JOB_RUN_ID=$(aws glue start-job-run \
            --job-name FinalGlue \
            --query JobRunId \
            --output text)

          echo "Started Glue Job: $JOB_RUN_ID"

          while true; do
            STATUS=$(aws glue get-job-run \
              --job-name FinalGlue \
              --run-id $JOB_RUN_ID \
              --query JobRun.JobRunState \
              --output text)

            echo "Glue Job status: $STATUS"

            if [ "$STATUS" = "SUCCEEDED" ]; then
              break
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ]; then
              exit 1
            fi

            sleep 30
          done

      # ---------------- AIRLINE CRAWLER ----------------
      - name: Run Airline Crawler
        run: |
          aws glue start-crawler --name airline || echo "airline already running"

          while true; do
            STATE=$(aws glue get-crawler \
              --name airline \
              --query 'Crawler.State' \
              --output text)

            if [ "$STATE" = "READY" ]; then
              break
            fi
            sleep 20
          done

          STATUS=$(aws glue get-crawler \
            --name airline \
            --query 'Crawler.LastCrawl.Status' \
            --output text)

          echo "Airline crawler status: $STATUS"

          if [ "$STATUS" != "SUCCEEDED" ]; then
            exit 1
          fi

      # ---------------- CUSTOMERS CRAWLER ----------------
      - name: Run Customers Crawler
        run: |
          aws glue start-crawler --name customers || echo "customers already running"

          while true; do
            STATE=$(aws glue get-crawler \
              --name customers \
              --query 'Crawler.State' \
              --output text)

            if [ "$STATE" = "READY" ]; then
              break
            fi
            sleep 20
          done

          STATUS=$(aws glue get-crawler \
            --name customers \
            --query 'Crawler.LastCrawl.Status' \
            --output text)

          echo "Customers crawler status: $STATUS"

          if [ "$STATUS" != "SUCCEEDED" ]; then
            exit 1
          fi

      - name: Pipeline Success
        run: echo "ðŸŽ‰ Glue Job + Airline DB + Customers DB updated successfully"
