name: Glue Full CI/CD

on:
  push:
    branches: [ "develop" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      BUCKET: airport-airline-operations-analytics-platform

      GLUE_SCRIPT: glue_job.py
      GLUE_SCRIPT_KEY: scripts/glue_job.py

      RAW_LAMBDA_FILE: raw_lambda.py
      RAW_LAMBDA_KEY: lambda/raw_lambda.zip

      CRAWLER_LAMBDA_FILE: crawler_lambda.py
      CRAWLER_LAMBDA_KEY: lambda/crawler_lambda.zip

      GLUE_STACK: glue-stack
      CRAWLER_STACK: crawler-stack
      RAW_LAMBDA_STACK: raw-lambda-stack
      CRAWLER_LAMBDA_STACK: crawler-lambda-stack

      GLUE_JOB: FinalGlue

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      # ---------- sanity checks ----------
      - name: Verify required S3 objects exist
        run: |
          aws s3 ls s3://$BUCKET/$GLUE_SCRIPT_KEY
          aws s3 ls s3://$BUCKET/$RAW_LAMBDA_KEY
          aws s3 ls s3://$BUCKET/$CRAWLER_LAMBDA_KEY

      # ---------- upload artifacts ----------
      - name: Upload Glue Script
        run: |
          aws s3 cp "$GLUE_SCRIPT" "s3://$BUCKET/$GLUE_SCRIPT_KEY"

      - name: Zip and Upload RAW Lambda
        run: |
          zip -j raw.zip "$RAW_LAMBDA_FILE"
          aws s3 cp raw.zip "s3://$BUCKET/$RAW_LAMBDA_KEY"

      - name: Zip and Upload Crawler Lambda
        run: |
          zip -j crawler.zip "$CRAWLER_LAMBDA_FILE"
          aws s3 cp crawler.zip "s3://$BUCKET/$CRAWLER_LAMBDA_KEY"

      # ---------- deploy stacks ----------
      - name: Deploy Glue Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$GLUE_STACK" \
            --template-file glue-template.yaml \
            --parameter-overrides \
              ScriptBucket="$BUCKET" \
              ScriptKey="$GLUE_SCRIPT_KEY" \
              TempBucket="$BUCKET" \
              JobName="$GLUE_JOB" \
            --capabilities CAPABILITY_NAMED_IAM

      - name: Deploy Crawler Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$CRAWLER_STACK" \
            --template-file crawler-template.yaml \
            --parameter-overrides \
              DataBucket="$BUCKET" \
            --capabilities CAPABILITY_NAMED_IAM

      - name: Deploy RAW Lambda Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$RAW_LAMBDA_STACK" \
            --template-file lambda-template.yaml \
            --parameter-overrides \
              LambdaName="raw-trigger-lambda" \
              CodeBucket="$BUCKET" \
              CodeKey="$RAW_LAMBDA_KEY" \
            --capabilities CAPABILITY_NAMED_IAM

      - name: Deploy Crawler Lambda Stack
        run: |
          aws cloudformation deploy \
            --stack-name "$CRAWLER_LAMBDA_STACK" \
            --template-file lambda-template.yaml \
            --parameter-overrides \
              LambdaName="crawler-trigger-lambda" \
              CodeBucket="$BUCKET" \
              CodeKey="$CRAWLER_LAMBDA_KEY" \
            --capabilities CAPABILITY_NAMED_IAM

      # ---------- invoke and wait ----------
      - name: Invoke RAW Lambda
        run: |
          aws lambda invoke --function-name "raw-trigger-lambda" out.json
          cat out.json

      - name: Wait for Glue Job
        run: |
          for i in {1..80}; do
            STATUS=$(aws glue get-job-runs \
              --job-name "$GLUE_JOB" \
              --query 'JobRuns[0].JobRunState' \
              --output text)
            echo "Glue status: $STATUS"
            [ "$STATUS" = "SUCCEEDED" ] && exit 0
            [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "STOPPED" ] && exit 1
            sleep 30
          done
          exit 1

      - name: Invoke Crawler Lambda
        run: |
          aws lambda invoke --function-name "crawler-trigger-lambda" crawl.json
          cat crawl.json

      - name: Wait Airline Crawler
        run: |
          while true; do
            STATE=$(aws glue get-crawler --name "airline" --query 'Crawler.State' --output text)
            echo "Airline: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      - name: Wait Customers Crawler
        run: |
          while true; do
            STATE=$(aws glue get-crawler --name "customers" --query 'Crawler.State' --output text)
            echo "Customers: $STATE"
            [ "$STATE" = "READY" ] && break
            sleep 20
          done

      - name: DONE
        run: echo "âœ… FULL FLOW SUCCESS"
